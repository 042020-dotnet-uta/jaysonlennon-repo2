# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

resources:
- repo: self

stages:
- stage: BuildAPI
  jobs:
  - job: build
    steps:
    - bash: |
        cd Project2/AptMgmtPortalAPI
        dotnet build
    displayName: 'build'
  - job: publish
    steps:
    - bash: |
        cd Project2/AptMgmtPortalAPI
        dotnet publish -c Release -o release
    - publish: $(System.DefaultWorkingDirectory)/Project2/AptMgmtPortalAPI/release
      artifact: APIRelease

- stage: TestAPI
  jobs:
  - job: test
    steps:
    - bash: |
        cd Project2/Tests
        dotnet test
    displayName: 'test'

- stage: CoverageAPI
  jobs:
  - job: coverage
    steps:
    - bash: |
        export SONAR_SCANNER_VERSION=4.2.0.1873
        export SONAR_SCANNER_HOME=$HOME/.sonar/sonar-scanner-$SONAR_SCANNER_VERSION-linux
        curl --create-dirs -sSLo $HOME/.sonar/sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-$SONAR_SCANNER_VERSION-linux.zip
        unzip -o $HOME/.sonar/sonar-scanner.zip -d $HOME/.sonar/
        export PATH=$SONAR_SCANNER_HOME/bin:$PATH
        export SONAR_SCANNER_OPTS="-server"

        cd Project2/Tests
        dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
        cd ..

        sonar-scanner \
        -Dsonar.organization=21192782-9959-441f-9311-e9efbb0a57ef \
        -Dsonar.projectKey=21192782-9959-441f-9311-e9efbb0a57ef \
        -Dsonar.sources=. \
        -Dsonar.host.url=https://sonarcloud.io \
        -Dsonar.login=fc44ec84e5d6f1c4cb5d7fd7e841a44b544b5076 \
        -Dsonar.cs.opencover.reportsPaths=Tests/coverage.opencover.xml
    displayName: 'coverage'

- stage: DeployAPI
  jobs:
  - job: deploy
    steps:
    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'APIRelease'
        targetPath: 'release'
    - task: AzureRmWebAppDeployment@4
      inputs:
        ConnectionType: 'AzureRM'
        azureSubscription: 'Azure subscription 1(1)(add44282-5490-4beb-b46f-46afb591c142)'
        appType: 'webAppLinux'
        WebAppName: 'pipeline-app-jwl'
        packageForLinux: '$(System.DefaultWorkingDirectory)/release'
        RuntimeStack: 'DOTNETCORE|Latest'
        StartupCommand: 'dotnet AptMgmtPortalAPI.dll'

